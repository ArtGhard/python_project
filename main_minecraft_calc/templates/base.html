<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ page_title or 'Minecraft Calculator' }}</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="preload" as="image" href="{{ url_for('static', filename='images/Minecraft_Fall_Drop_Campaign_Key_Art_DotNet_Downloadable_Wallpaper_2560x1440.png') }}">
    <link rel="preload" as="image" href="{{ url_for('static', filename='images/main_icon.png') }}">
    <link rel="preload" as="image" href="{{ url_for('static', filename='images/diamond_sword.png') }}">
    <link rel="preload" as="image" href="{{ url_for('static', filename='images/grass.jpg') }}">
    <link rel="preload" as="image" href="{{ url_for('static', filename='images/stone.jpg') }}">
    <link rel="preload" as="image" href="{{ url_for('static', filename='images/Ender_Pearl_JE3_BE2.png') }}">
    <link rel="preload" as="style" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>
    <!-- КНОПКИ РЕГИСТАРЦИИ -->
    <div class="top-right-buttons">
        {% if user %}
            <div class="user-info">
                <img src="{{ url_for('static', filename='avatars/' + user[1]) }}" class="avatar">
                <span>{{ user[0] }}</span>
                <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm">Выйти</a>
            </div>
        {% else %}
            <button class="btn btn-outline-light btn-sm" data-bs-toggle="modal" data-bs-target="#registerModal">Зарегистрироваться</button>
            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#loginModal">Войти</button>
        {% endif %}
    </div>

    <!-- ОКНО РЕГИСТРАЦИИ -->
    <div class="modal fade" id="registerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Регистрация</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="registerForm">
                        <div class="mb-3">
                            <label for="regUsername" class="form-label">Логин (уникальное имя)</label>
                            <input type="text" class="form-control" id="regUsername" required>
                        </div>
                        <div class="mb-3">
                            <label for="regNickname" class="form-label">Никнейм</label>
                            <input type="text" class="form-control" id="regNickname" required>
                        </div>
                        <div class="mb-3">
                            <label for="regPassword" class="form-label">Пароль</label>
                            <input type="password" class="form-control" id="regPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="regConfirmPassword" class="form-label">Подтвердите пароль</label>
                            <input type="password" class="form-control" id="regConfirmPassword" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Аватарка</label>
                            <div class="avatar-selection">
                                <label class="avatar-option">
                                    <input type="radio" name="avatar" value="default.png" checked>
                                    <img src="{{ url_for('static', filename='avatars/default.png') }}" class="avatar-preview">
                                </label>
                                <label class="avatar-option">
                                    <input type="radio" name="avatar" value="alex.png">
                                    <img src="{{ url_for('static', filename='avatars/alex.png') }}" class="avatar-preview">
                                </label>
                                <label class="avatar-option">
                                    <input type="radio" name="avatar" value="steve.png">
                                    <img src="{{ url_for('static', filename='avatars/steve.png') }}" class="avatar-preview">
                                </label>
                                <label class="avatar-option">
                                    <input type="radio" name="avatar" value="chiken.png">
                                    <img src="{{ url_for('static', filename='avatars/chiken.png') }}" class="avatar-preview">
                                </label>
                                <label class="avatar-option">
                                    <input type="radio" name="avatar" value="cow.png">
                                    <img src="{{ url_for('static', filename='avatars/cow.png') }}" class="avatar-preview">
                                </label>
                                <label class="avatar-option">
                                    <input type="radio" name="avatar" value="creeper.png">
                                    <img src="{{ url_for('static', filename='avatars/creeper.png') }}" class="avatar-preview">
                                </label>
                                <label class="avatar-option">
                                    <input type="radio" name="avatar" value="sheep.png">
                                    <img src="{{ url_for('static', filename='avatars/sheep.png') }}" class="avatar-preview">
                                </label>
                                <label class="avatar-option">
                                    <input type="radio" name="avatar" value="skeleton.png">
                                    <img src="{{ url_for('static', filename='avatars/skeleton.png') }}" class="avatar-preview">
                                </label>
                                <label class="avatar-option">
                                    <input type="radio" name="avatar" value="zombie.png">
                                    <img src="{{ url_for('static', filename='avatars/zombie.png') }}" class="avatar-preview">
                                </label>
                                <label class="avatar-option">
                                    <input type="radio" name="avatar" value="villager.png">
                                    <img src="{{ url_for('static', filename='avatars/villager.png') }}" class="avatar-preview">
                                </label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Зарегистрироваться</button>
                    </form>
                    <div id="regMessage" class="mt-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ОКНО ВХОДА -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Вход</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="loginUsername" class="form-label">Имя пользователя</label>
                            <input type="text" class="form-control" id="loginUsername" required>
                        </div>
                        <div class="mb-3">
                            <label for="loginPassword" class="form-label">Пароль</label>
                            <input type="password" class="form-control" id="loginPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Войти</button>
                    </form>
                    <div id="loginMessage" class="mt-2"></div>
                </div>
            </div>
        </div>
    </div>

    {% block content %}
    {% endblock %}

    {% block footer %}
    <div class="page-footer"></div>
    {% endblock %}

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        // РЕГИСТРАЦИЯ
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          const username = document.getElementById('regUsername').value;
          const nickname = document.getElementById('regNickname').value;
          const password = document.getElementById('regPassword').value;
          const confirm = document.getElementById('regConfirmPassword').value;
          const avatar = document.querySelector('input[name="avatar"]:checked').value;
        
          const response = await fetch('/register', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: new URLSearchParams({username, nickname, password, confirm_password: confirm, avatar})
          });
          const data = await response.json();
        
          const msg = document.getElementById('regMessage');
          if (data.success) {
            msg.innerHTML = '<div class="alert alert-success">Успешно! Теперь вы можете войти.</div>';
            document.getElementById('registerForm').reset();
            // Выбираем первую аватарку по умолчанию
            document.querySelector('input[name="avatar"][value="default.png"]').checked = true;
            bootstrap.Modal.getInstance(document.getElementById('registerModal')).hide();
          } else {
            msg.innerHTML = '<div class="alert alert-danger">' + data.message + '</div>';
          }
        });

        // ВХОД
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          const username = document.getElementById('loginUsername').value;
          const password = document.getElementById('loginPassword').value;

          const response = await fetch('/login', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: new URLSearchParams({username, password})
          });
          const data = await response.json();

          const msg = document.getElementById('loginMessage');
          if (data.success) {
            location.reload();
          } else {
            msg.innerHTML = '<div class="alert alert-danger">' + data.message + '</div>';
          }
        });

        const buttons = [
          { btnId: 'calculate-btn', iconId: 'pearl-icon' },
          { btnId: 'clear-btn', iconId: 'furn-icon' }
        ];

        buttons.forEach(({ btnId, iconId }) => {
          const button = document.getElementById(btnId);
          const icon = document.getElementById(iconId);
          if (button && icon) {
            const defaultSrc = icon.dataset.default;
            const hoverSrc = icon.dataset.hover;
            button.addEventListener('mouseenter', () => icon.src = hoverSrc);
            button.addEventListener('mouseleave', () => icon.src = defaultSrc);
          }
        });
      });
    </script>
</body>
</html>